"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});const Channel_1=__importDefault(require("./Structures/Channel")),Playlist_1=__importDefault(require("./Structures/Playlist")),Video_1=__importDefault(require("./Structures/Video")),PLAYLIST_REGEX=/^https?:\/\/(www.)?youtube.com\/playlist\?list=((PL|UU|LL|RD|OL)[a-zA-Z0-9-_]{16,41})$/,PLAYLIST_ID=/(PL|UU|LL|RD|OL)[a-zA-Z0-9-_]{16,41}/,VIDEO_URL=/^((?:https?:)?\/\/)?((?:www|m)\.)?((?:youtube\.com|youtu.be))(\/(?:[\w\-]+\?v=|embed\/|v\/)?)([\w\-]+)(\S+)?$/,VIDEO_ID=/^[a-zA-Z0-9-_]{11}$/,fetch=getFetch();function getFetch(){return"undefined"!=typeof window?window.fetch:require("node-fetch")}class Util{constructor(){throw new Error(`The ${this.constructor.name} class may not be instantiated!`)}static get VideoRegex(){return VIDEO_URL}static get VideoIDRegex(){return VIDEO_ID}static get PlaylistURLRegex(){return PLAYLIST_REGEX}static get PlaylistIDRegex(){return PLAYLIST_ID}static getHTML(url,requestOptions){return requestOptions||(requestOptions={}),new Promise((resolve,reject)=>{fetch(url,requestOptions).then(res=>res.text()).then(html=>resolve(html)).catch(e=>reject(e))})}static parseDuration(duration){const args=duration.split(":");let dur=0;switch(args.length){case 3:dur=60*parseInt(args[0])*60*1e3+60*parseInt(args[1])*1e3+1e3*parseInt(args[2]);break;case 2:dur=60*parseInt(args[0])*1e3+1e3*parseInt(args[1]);break;default:dur=1e3*parseInt(args[0])}return dur}static parseSearchResult(html,options){if(!html)throw new Error("Invalid raw data");options||(options={type:"video",limit:0}),options.type||(options.type="video");const results=[];let details=[],fetched=!1;try{let data=html.split("ytInitialData = JSON.parse('")[1].split("');<\/script>")[0];html=data.replace(/\\x([0-9A-F]{2})/gi,(...items)=>String.fromCharCode(parseInt(items[1],16)))}catch(_a){}try{details=JSON.parse(html.split('{"itemSectionRenderer":{"contents":')[html.split('{"itemSectionRenderer":{"contents":').length-1].split(',"continuations":[{')[0]),fetched=!0}catch(_b){}if(!fetched)try{details=JSON.parse(html.split('{"itemSectionRenderer":')[html.split('{"itemSectionRenderer":').length-1].split('},{"continuationItemRenderer":{')[0]).contents,fetched=!0}catch(_c){}if(!fetched)return[];for(let i=0;i<details.length&&!("number"==typeof options.limit&&options.limit>0&&results.length>=options.limit);i++){let data=details[i],res;if("all"===options.type)if(data.videoRenderer)options.type="video";else if(data.channelRenderer)options.type="channel";else{if(!data.playlistRenderer)continue;options.type="playlist"}if("video"===options.type){const parsed=Util.parseVideo(data);if(!parsed)continue;res=parsed}else if("channel"===options.type){const parsed=Util.parseChannel(data);if(!parsed)continue;res=parsed}else if("playlist"===options.type){const parsed=Util.parsePlaylist(data);if(!parsed)continue;res=parsed}results.push(res)}return results}static parseChannel(data){var _a,_b;if(!data||!data.channelRenderer)return;const badge=data.channelRenderer.ownerBadges&&data.channelRenderer.ownerBadges[0];let url=`https://www.youtube.com${data.channelRenderer.navigationEndpoint.browseEndpoint.canonicalBaseUrl||data.channelRenderer.navigationEndpoint.commandMetadata.webCommandMetadata.url}`,res;return new Channel_1.default({id:data.channelRenderer.channelId,name:data.channelRenderer.title.simpleText,icon:data.channelRenderer.thumbnail.thumbnails[data.channelRenderer.thumbnail.thumbnails.length-1],url:url,verified:Boolean(null===(_b=null===(_a=null==badge?void 0:badge.metadataBadgeRenderer)||void 0===_a?void 0:_a.style)||void 0===_b?void 0:_b.toLowerCase().includes("verified")),subscribers:data.channelRenderer.subscriberCountText.simpleText})}static parseVideo(data){var _a,_b,_c,_d,_e,_f,_g;if(!data||!data.videoRenderer)return;const badge=data.videoRenderer.ownerBadges&&data.videoRenderer.ownerBadges[0];let res;return new Video_1.default({id:data.videoRenderer.videoId,url:`https://www.youtube.com/watch?v=${data.videoRenderer.videoId}`,title:data.videoRenderer.title.runs[0].text,description:data.videoRenderer.descriptionSnippet&&data.videoRenderer.descriptionSnippet.runs[0]?data.videoRenderer.descriptionSnippet.runs[0].text:"",duration:data.videoRenderer.lengthText?Util.parseDuration(data.videoRenderer.lengthText.simpleText):0,duration_raw:data.videoRenderer.lengthText?data.videoRenderer.lengthText.simpleText:null,thumbnail:{id:data.videoRenderer.videoId,url:data.videoRenderer.thumbnail.thumbnails[data.videoRenderer.thumbnail.thumbnails.length-1].url,height:data.videoRenderer.thumbnail.thumbnails[data.videoRenderer.thumbnail.thumbnails.length-1].height,width:data.videoRenderer.thumbnail.thumbnails[data.videoRenderer.thumbnail.thumbnails.length-1].width},channel:{id:data.videoRenderer.ownerText.runs[0].navigationEndpoint.browseEndpoint.browseId||null,name:data.videoRenderer.ownerText.runs[0].text||null,url:`https://www.youtube.com${data.videoRenderer.ownerText.runs[0].navigationEndpoint.browseEndpoint.canonicalBaseUrl||data.videoRenderer.ownerText.runs[0].navigationEndpoint.commandMetadata.webCommandMetadata.url}`,icon:{url:data.videoRenderer.channelThumbnailSupportedRenderers.channelThumbnailWithLinkRenderer.thumbnail.thumbnails[0].url,width:data.videoRenderer.channelThumbnailSupportedRenderers.channelThumbnailWithLinkRenderer.thumbnail.thumbnails[0].width,height:data.videoRenderer.channelThumbnailSupportedRenderers.channelThumbnailWithLinkRenderer.thumbnail.thumbnails[0].height},verified:Boolean(null===(_b=null===(_a=null==badge?void 0:badge.metadataBadgeRenderer)||void 0===_a?void 0:_a.style)||void 0===_b?void 0:_b.toLowerCase().includes("verified"))},uploadedAt:null!==(_d=null===(_c=data.videoRenderer.publishedTimeText)||void 0===_c?void 0:_c.simpleText)&&void 0!==_d?_d:null,views:null!==(_g=null===(_f=null===(_e=data.videoRenderer.viewCountText)||void 0===_e?void 0:_e.simpleText)||void 0===_f?void 0:_f.replace(/[^0-9]/g,""))&&void 0!==_g?_g:0})}static parsePlaylist(data){if(!data.playlistRenderer)return;const res=new Playlist_1.default({id:data.playlistRenderer.playlistId,title:data.playlistRenderer.title.simpleText,thumbnail:{id:data.playlistRenderer.playlistId,url:data.playlistRenderer.thumbnails[0].thumbnails[data.playlistRenderer.thumbnails[0].thumbnails.length-1].url,height:data.playlistRenderer.thumbnails[0].thumbnails[data.playlistRenderer.thumbnails[0].thumbnails.length-1].height,width:data.playlistRenderer.thumbnails[0].thumbnails[data.playlistRenderer.thumbnails[0].thumbnails.length-1].width},channel:{id:data.playlistRenderer.shortBylineText.runs[0].navigationEndpoint.browseEndpoint.browseId,name:data.playlistRenderer.shortBylineText.runs[0].text,url:`https://www.youtube.com${data.playlistRenderer.shortBylineText.runs[0].navigationEndpoint.commandMetadata.webCommandMetadata.url}`},videos:parseInt(data.playlistRenderer.videoCount.replace(/[^0-9]/g,""))},!0);return res}static getPlaylist(html,limit){var _a,_b;limit&&"number"==typeof limit||(limit=100),limit<=0&&(limit=100);const videos=[];let parsed,playlistDetails;try{const rawJSON=`${html.split('{"playlistVideoListRenderer":{"contents":')[1].split('}],"playlistId"')[0]}}]`;parsed=JSON.parse(rawJSON),playlistDetails=JSON.parse(html.split('{"playlistSidebarRenderer":')[1].split("}};<\/script>")[0]).items}catch(e){return null}for(let i=0;i<parsed.length&&limit!==videos.length;i++){const info=parsed[i].playlistVideoRenderer;info&&info.shortBylineText&&videos.push(new Video_1.default({id:info.videoId,index:parseInt(info.index.simpleText)||0,duration:Util.parseDuration(info.lengthText.simpleText)||0,duration_raw:info.lengthText.simpleText,thumbnail:{id:info.videoId,url:info.thumbnail.thumbnails[info.thumbnail.thumbnails.length-1].url,height:info.thumbnail.thumbnails[info.thumbnail.thumbnails.length-1].height,width:info.thumbnail.thumbnails[info.thumbnail.thumbnails.length-1].width},title:info.title.runs[0].text,channel:{id:info.shortBylineText.runs[0].navigationEndpoint.browseEndpoint.browseId||null,name:info.shortBylineText.runs[0].text||null,url:`https://www.youtube.com${info.shortBylineText.runs[0].navigationEndpoint.browseEndpoint.canonicalBaseUrl||info.shortBylineText.runs[0].navigationEndpoint.commandMetadata.webCommandMetadata.url}`,icon:null}}))}const data=playlistDetails[0].playlistSidebarPrimaryInfoRenderer;if(!data.title.runs||!data.title.runs.length)return null;const author=null===(_a=playlistDetails[1])||void 0===_a?void 0:_a.playlistSidebarSecondaryInfoRenderer.videoOwner,views=3===data.stats.length?data.stats[1].simpleText.replace(/[^0-9]/g,""):0,lastUpdate=3===data.stats.length?data.stats[2].runs?data.stats[2].runs[0].text:data.stats[2].simpleText:data.stats[1].simpleText,videosCount=data.stats[0].runs[0].text.replace(/[^0-9]/g,"")||0,res=new Playlist_1.default({id:data.title.runs[0].navigationEndpoint.watchEndpoint.playlistId,title:data.title.runs[0].text,videoCount:parseInt(videosCount)||0,lastUpdate:lastUpdate||null,views:parseInt(views)||0,videos:videos,url:`https://www.youtube.com/playlist?list=${data.title.runs[0].navigationEndpoint.watchEndpoint.playlistId}`,link:`https://www.youtube.com${data.title.runs[0].navigationEndpoint.commandMetadata.webCommandMetadata.url}`,author:author?{name:author.videoOwnerRenderer.title.runs[0].text,id:author.videoOwnerRenderer.title.runs[0].navigationEndpoint.browseEndpoint.browseId,url:`https://www.youtube.com${author.videoOwnerRenderer.navigationEndpoint.commandMetadata.webCommandMetadata.url||author.videoOwnerRenderer.navigationEndpoint.browseEndpoint.canonicalBaseUrl}`,icon:author.videoOwnerRenderer.thumbnail.thumbnails.length?author.videoOwnerRenderer.thumbnail.thumbnails[author.videoOwnerRenderer.thumbnail.thumbnails.length-1].url:null}:{},thumbnail:(null===(_b=data.thumbnailRenderer.playlistVideoThumbnailRenderer)||void 0===_b?void 0:_b.thumbnail.thumbnails.length)?data.thumbnailRenderer.playlistVideoThumbnailRenderer.thumbnail.thumbnails[data.thumbnailRenderer.playlistVideoThumbnailRenderer.thumbnail.thumbnails.length-1].url:null});return res}static getVideo(html){var _a;let data;try{const parsed=JSON.parse(html.split("var ytInitialData = ")[1].split(";<\/script>")[0]);data=parsed.contents.twoColumnWatchNextResults.results.results.contents}catch(_b){throw new Error("Could not parse video metadata!")}const raw={primary:data[0].videoPrimaryInfoRenderer,secondary:data[1].videoSecondaryInfoRenderer};let info;try{info=JSON.parse(html.split("var ytInitialPlayerResponse = ")[1].split(";<\/script>")[0]).videoDetails}catch(_c){info=JSON.parse(html.split("var ytInitialPlayerResponse = ")[1].split(";var meta")[0]).videoDetails}info=Object.assign(Object.assign(Object.assign({},raw.primary),raw.secondary),{info:info});const payload=new Video_1.default({id:info.info.videoId,title:info.info.title,views:parseInt(info.info.viewCount)||0,tags:info.info.keywords,private:info.info.isPrivate,live:info.info.isLiveContent,duration:parseInt(info.info.lengthSeconds),duration_raw:Util.durationString(Util.parseMS(1e3*parseInt(info.info.lengthSeconds)||0)),channel:{name:info.info.author,id:info.info.channelId,url:`https://www.youtube.com${info.owner.videoOwnerRenderer.title.runs[0].navigationEndpoint.browseEndpoint.canonicalBaseUrl}`,icon:info.owner.videoOwnerRenderer.thumbnail.thumbnails[0],subscribers:null===(_a=info.owner.videoOwnerRenderer.subscriberCountText.simpleText)||void 0===_a?void 0:_a.replace(" subscribers","")},description:info.info.shortDescription,thumbnail:Object.assign(Object.assign({},info.info.thumbnail.thumbnails[info.info.thumbnail.thumbnails.length-1]),{id:info.info.videoId}),uploadedAt:info.dateText.simpleText,ratings:{likes:parseInt(info.sentimentBar.sentimentBarRenderer.tooltip.split(" / ")[0].replace(/,/g,"")),dislikes:parseInt(info.sentimentBar.sentimentBarRenderer.tooltip.split(" / ")[1].replace(/,/g,""))}});return payload}static getPlaylistURL(url){if("string"!=typeof url)return null;const group=PLAYLIST_ID.exec(url);if(!group)return null;const finalURL=`https://www.youtube.com/playlist?list=${group[0]}`;return finalURL}static validatePlaylist(url){if("string"!=typeof url||null===url.match(PLAYLIST_ID))throw new Error("Invalid playlist url")}static filter(ftype){switch(ftype){case"playlist":return"EgIQAw%253D%253D";case"video":return"EgIQAQ%253D%253D";case"channel":return"EgIQAg%253D%253D";default:throw new TypeError(`Invalid filter type "${ftype}"!`)}}static parseMS(milliseconds){const roundTowardsZero=milliseconds>0?Math.floor:Math.ceil;return{days:roundTowardsZero(milliseconds/864e5),hours:roundTowardsZero(milliseconds/36e5)%24,minutes:roundTowardsZero(milliseconds/6e4)%60,seconds:roundTowardsZero(milliseconds/1e3)%60}}static durationString(data){const items=Object.keys(data),required=["days","hours","minutes","seconds"],parsed=items.filter(x=>required.includes(x)).map(m=>data[m]>0?data[m]:""),final=parsed.filter(x=>!!x).map(x=>x.toString().padStart(2,"0")).join(":");return final.length<=3?`0:${final.padStart(2,"0")||0}`:final}}exports.default=Util;